# Генерация клиентов

**drf-spectacular** направлен на создание наиболее точной схемы, возможной в условиях ограничений OpenAPI 3.0.3. К сожалению, иногда эта цель противоречит созданию хорошего и функционального клиента.

Для обслуживания двух основных вариантов использования, т. е. документирования API и создания клиентов, мы сначала выбираем наиболее точную схему, а затем предоставляем настройки, позволяющие решить потенциальные проблемы с созданием клиентов.

{% hint style="info" %}
TL; DR — простая установка `'COMPONENT_SPLIT_REQUEST': True`, скорее всего, даст лучший и самый точный клиент.
{% endhint %}

{% hint style="info" %}
**drf-spectacular** генерирует предупреждения, когда распознает потенциальные проблемы. Некоторые предупреждения важны для корректного клиента. Настоятельно рекомендуется исправить все предупреждения.
{% endhint %}

{% hint style="info" %}
Для создания клиентов с CI мы настоятельно рекомендуем использовать `./manage.py visible --file schema.yaml --validate --fail-on-warn`, чтобы выявить потенциальные проблемы на ранней стадии.
{% endhint %}

## Проблемы с компонентами

Большинство клиентских проблем связаны с созданием компонентов. У некоторых целевых клиентов возникают проблемы с **readOnly** и полями **required**, такими как **id**. Несмотря на то, что сгенерированный код технически правильный, он может не позволять создавать объекты с отсутствующим идентификатором **id** для POST-запросов. Некоторые поля, такие как **FileField**, ведут себя по-разному в запросах и ответах и просто не могут быть преобразованы в один компонент.

Наиболее полезным параметром является `'COMPONENT_SPLIT_REQUEST': True`, когда все затронутые компоненты разделены на компоненты запроса и ответа. Это позаботится почти обо всех проблемах, **required**, **writeOnly**, **readOnly**, и, как правило, предоставляет код, который легче понять и сложнее использовать неправильно.

Иногда вы можете захотеть исправить только проблему **required**/**readOnly** без разделения всех компонентов. Это можно явно решить с помощью `'COMPONENT_NO_READ_ONLY_REQUIRED': True`. Поскольку этот параметр снижает правильность схемы, мы обычно рекомендуем вместо этого использовать **COMPONENT\_SPLIT\_REQUEST**.

`'COMPONENT_SPLIT_PATCH': True` уже включено по умолчанию, поскольку запросы PATCH и POST противоречат свойству **required** и не могут быть адекватно смоделированы с помощью одного компонента.

Соответствующие настройки:

```python
# Разделите компоненты на части запроса и ответа, где это необходимо
'COMPONENT_SPLIT_REQUEST': False,
# Помогите целевым объектам генератора клиентов, у которых есть проблемы
# со свойствами, доступными только для чтения.
'COMPONENT_NO_READ_ONLY_REQUIRED': False,
# Создайте отдельные компоненты для конечных точек PATCH (без обязательного списка)
'COMPONENT_SPLIT_PATCH': True,
```

## Проблемы с перечислением Enum

Некоторые цели генератора подавляются комбинированными компонентами перечисления или имеют выбор **null** в поле, допускающем значение `null: true`. Несмотря на то, что это правильный путь (согласно спецификации), он, к сожалению, нарушает некоторые цели генератора. Установка `'ENUM_ADD_EXPLICIT_BLANK_NULL_CHOICE': False` создаст менее точную схему, которая имеет тенденцию нарушать меньше целей генератора.

Для получения дополнительной информации обратитесь к [официальной документации](https://swagger.io/docs/specification/data-models/enums/) и, в частности, к [предложению по спецификации](https://github.com/OAI/OpenAPI-Specification/blob/main/proposals/2019-10-31-Clarify-Nullable.md#user-content-if-a-schema-specifies-nullable-true-and-enum-1-2-3-does-that-schema-allow-null-values-see-1900).

Соответствующие настройки:

```python
# Добавляет "blank" и "null" варианты перечисления, где это уместно.
# отключить при проблемах с генерацией клиентов
'ENUM_ADD_EXPLICIT_BLANK_NULL_CHOICE': True,
```

## Проблемы с типом

Некоторые цели генератора ведут себя по-разному в зависимости от того, как структурированы дополнительные свойства `additionalProperties`. По спецификации все три варианта должны давать одинаковые результаты, что, к сожалению, на практике не так.

Соответствующие настройки:

```python
# Определяет, следует ли создавать в схеме дополнительные свойства произвольной формы
# и каким образом. Некоторые цели генератора кода чувствительны к этому.
# None отключает общие 'additionalProperties'.
# допустимые значения 'dict', 'bool', None
'GENERIC_ADDITIONAL_PROPERTIES': 'dict',
```
